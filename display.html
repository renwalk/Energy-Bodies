<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Energy Bodies — Display</title>
  <link rel="icon" href="data:,">
  <!-- Local libs (blocking) -->
  <!-- Load eb-init.js FIRST - before p5.js and sketch.js -->
  <script src="eb-init.js"></script>

  <!-- Then load p5.js -->
  <script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.min.js"></script>

  <!-- Then load ml5 -->
  <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>


  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      background: #000;
      overflow: hidden;
    }

    canvas {
      display: block;
    }

    .portrait body,
    body.portrait {
      transform-origin: center center;
    }
  </style>
</head>

<body>

  <script>
    // =====================================================
    // Energy Bodies — Display Receiver (no HUD)
    // Bridges WS messages from Control → sketch.js (no DOM UI)
    // =====================================================
    (function () {
      // Exposed helpers your sketch.js can call
      const Emitter = {
        socket: null,
        pose(obj) { safeSend({ type: 'pose', ...obj }); },
        tracking(on) { safeSend({ type: 'tracking', on: !!on }); },
        echo(state) {
          const payload = { type: 'echo' };
          if (state && state.emotion) payload.emotion = state.emotion;
          if (state && state.region) payload.region = state.region;
          safeSend(payload);
        }
      };
      window.EnergyBodiesDisplay = Emitter;

      // Orientation handling → dispatch event for sketch.js
      function applyOrientation(value) {
        const cls = (value === 'portrait') ? 'portrait' : 'landscape';
        document.body.classList.toggle('portrait', cls === 'portrait');
        window.dispatchEvent(new CustomEvent('eb:orientation', { detail: { value: cls } }));
      }

      // WebSocket with auto-retry
      let socket; let retry = 800; const MAX = 8000;
      function wsUrl(port = 8080) {
        const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
        return `${proto}://${location.hostname}:${port}`;
      }
      function connect() {
        try { socket = new WebSocket(wsUrl(8080)); }
        catch (e) { return setTimeout(connect, retry); }
        Emitter.socket = socket;

        socket.onopen = () => { retry = 800; };
        socket.onclose = () => { setTimeout(connect, Math.min(MAX, (retry *= 1.6))); };
        socket.onerror = () => { };
        socket.onmessage = (event) => {
          const handle = (txt) => { let msg; try { msg = JSON.parse(txt); } catch { return; } route(msg); };
          if (event.data instanceof Blob) {
            const r = new FileReader();
            r.onload = () => handle(r.result);
            r.readAsText(event.data);
          } else {
            handle(String(event.data));
          }
        };
      }
      connect();

      function safeSend(obj) {
        if (Emitter.socket && Emitter.socket.readyState === WebSocket.OPEN) {
          try { Emitter.socket.send(JSON.stringify(obj)); } catch { }
        }
      }

      // --- Defer-to-when-ready helper (prevents race with sketch.js binding)
      function callWhen(fnName, attempt = 0) {
        const fn = window[fnName];
        if (typeof fn === 'function') return fn();
        if (attempt < 20) return setTimeout(() => callWhen(fnName, attempt + 1), 100); // wait up to ~2s
        console.warn(`[DISPLAY] ${fnName} not found after waiting`);
      }

      // Route control messages → sketch.js
      function route(payload) {
        const { type } = payload || {};
        if (!type) return;

        // Sliders → apply to renderer mirrors
        if (type === 'sliders') {
          if (typeof window.applySliders === 'function') {
            window.applySliders(payload.emotion || {}, payload.region || {});
          }
          return;
        }

        // Explicit startTracking from Control (deferred-safe)
        if (type === 'startTracking') {
          console.log('[DISPLAY] startTracking (deferred if needed)');
          callWhen('startTracking');
          EnergyBodiesDisplay.tracking(true);
          return;
        }


        // Compact "action" API (start/stop/reset)
        if (type === 'action') {
          if (payload.action === 'start') {
            console.log('[DISPLAY] action:start');
            callWhen('startTracking');
            EnergyBodiesDisplay.tracking(true);
            return;
          }
          if (payload.action === 'stop') {
            console.log('[DISPLAY] action:stop');
            callWhen('stopTracking');
            EnergyBodiesDisplay.tracking(false);
            return;
          }
          if (payload.action === 'reset') {
            console.log('[DISPLAY] action:reset');
            if (typeof window.resetAll === 'function') {
              window.resetAll(); // full zero + stop tracking
            } else {
              console.warn('[DISPLAY] resetAll not found, dispatching eb:reset');
              window.dispatchEvent(new CustomEvent('eb:reset'));
            }
            EnergyBodiesDisplay.tracking(false);
            return;
          }
        }

        // Orientation toggle
        if (type === 'orientation') {
          applyOrientation(payload.value);
          return;
        }

        // Print → direct snapshot card
        if (type === 'print') {
          console.log('[DISPLAY] print → direct onPrintClick');
          if (typeof window.onPrintClick === 'function') {
            window.onPrintClick();
          } else {
            console.warn('[DISPLAY] onPrintClick not found');
          }
          return;
        }
      }

      // Announce initial state (optional)
      Emitter.tracking(false);
    })();
  </script>

  <script>
    // Snapshot → 4×6 print with full-bleed image + Gimlet footer
    window.onPrintClick = function () {
      console.log('[DISPLAY] Snapshot print with footer');

      let imgDataUrl = null;

      // 1) Capture the current frame from the canvas
      try {
        if (typeof window.captureOnWhiteForPrint === 'function') {
          // use your helper if present
          imgDataUrl = window.captureOnWhiteForPrint(2); // scale factor
        } else {
          const canvas = document.querySelector('canvas');
          if (!canvas) {
            console.error('[DISPLAY] No canvas found for printing');
            return;
          }
          imgDataUrl = canvas.toDataURL('image/jpeg', 0.92);
        }
      } catch (err) {
        console.error('[DISPLAY] Error capturing canvas for print:', err);
        return;
      }

      // 2) Simple metadata for footer
      const now = new Date();
      const dateStr = now.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
      const timeStr = now.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit'
      });

      // 3) Hidden iframe so there’s no big popup window
      let iframe = document.getElementById('eb-print-frame');
      if (!iframe) {
        iframe = document.createElement('iframe');
        iframe.id = 'eb-print-frame';
        iframe.style.position = 'fixed';
        iframe.style.width = '0';
        iframe.style.height = '0';
        iframe.style.border = '0';
        iframe.style.opacity = '0';
        iframe.style.pointerEvents = 'none';
        document.body.appendChild(iframe);
      }

      const printWindow = iframe.contentWindow;
      const doc = printWindow.document;

      // 4) 4×6 layout with full-bleed image + footer using Gimlet
      doc.open();
      doc.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8" />
      <title>Energy Bodies Print</title>
      <style>
        /* Gimlet fonts (same files as control, relative to display.html) */
        @font-face {
          font-family: "Gimlet Sans Micro";
          src: url("./fonts/GimletSansMicro-Light.otf") format("opentype");
          font-weight: 300;
          font-style: normal;
          font-display: swap;
        }
        @font-face {
          font-family: "Gimlet Sans Display";
          src: url("./fonts/GimletSansDisplay-Light.otf") format("opentype");
          font-weight: 300;
          font-style: normal;
          font-display: swap;
        }
        @font-face {
          font-family: "Gimlet Sans Text";
          src: url("./fonts/GimletSansText-Light.otf") format("opentype");
          font-weight: 300;
          font-style: normal;
          font-display: swap;
        }

        @page {
          size: 4in 6in;
          margin: 0;
        }
        html, body {
          margin: 0;
          padding: 0;
          width: 100%;
          height: 100%;
          background: #ffffff;
        }
        body {
          display: flex;
          align-items: stretch;
          justify-content: stretch;
          font-family: "Gimlet Sans Micro", -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
        }
        .wrapper {
          display: flex;
          flex-direction: column;
          width: 100%;
          height: 100%;
        }
        .image-wrap {
          flex: 1 1 auto;
          display: flex;
          align-items: center;
          justify-content: center;
          overflow: hidden;
        }
        .image-wrap img {
          width: 100%;
          height: 100%;
          object-fit: cover; /* near full-bleed on all sides */
        }
        .meta {
          flex: 0 0 auto;
          padding: 6px 10px 8px;
          font-size: 9px;
          line-height: 1.3;
          color: #111;
          border-top: 0.5px solid #e0e0e0;
        }
        .meta-title {
          font-family: "Gimlet Sans Display", "Gimlet Sans Text", system-ui, sans-serif;
          font-weight: 300;
          font-size: 10px;
          letter-spacing: 0.08em;
          text-transform: uppercase;
          margin-bottom: 2px;
        }
        .meta-line {
          font-family: "Gimlet Sans Micro", "Gimlet Sans Text", system-ui, sans-serif;
          opacity: 0.85;
        }
      </style>
    </head>
    <body>
      <div class="wrapper">
        <div class="image-wrap">
          <img id="toPrint" src="${imgDataUrl}" />
        </div>
        <div class="meta">
          <div class="meta-title">Energy Bodies</div>
          <div class="meta-line">MIT Media Lab · Info+ 2025</div>
          <div class="meta-line">${dateStr} · ${timeStr} · Session Snapshot</div>
        </div>
      </div>
      <script>
        const img = document.getElementById('toPrint');
        img.onload = function () {
          window.focus();
          window.print();
          window.onafterprint = () => {
            // optional: clear content after printing
            document.body.innerHTML = '';
          };
        };
      <\/script>
    </body>
    </html>
  `);
      doc.close();
    };
  </script>
  <!-- Your renderer LAST so it can see EnergyBodiesDisplay -->
  <script defer src="./sketch.js"></script>
</body>

</html>