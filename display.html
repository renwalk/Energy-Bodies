<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Energy Bodies — Display</title>
  <link rel="icon" href="data:,">

  <!-- Order: p5 → ml5 → sketch -->
<!-- 1) p5 FIRST (local) -->
<script src="/libs/p5.min.js"></script>


<!-- 2) ml5 AFTER p5 (local) -->
<script src="/libs/ml5.min.js"></script>


<!-- 3) YOUR SKETCH LAST -->
<script defer src="./sketch.js"></script>


  <style>
    html, body { margin:0; padding:0; background:#000; overflow:hidden; }
    canvas { display:block; }
    #hud { position:fixed; top:10px; left:12px; font:12px system-ui; color:#fff; opacity:.8; background:rgba(24,24,24,.6); padding:6px 8px; border-radius:8px; }
    .pill{ padding:2px 8px; border-radius:999px; background:#222; margin-left:6px; }
  </style>
</head>
<body>
<div id="hud">WS:<span id="ws" class="pill">-</span> ML5:<span id="ml5s" class="pill">-</span> Track:<span id="trk" class="pill">OFF</span></div>
<script>
let socket;
const HUD = { ws:document.getElementById('ws'), ml5s:document.getElementById('ml5s'), trk:document.getElementById('trk'), set(k,v){ this[k].textContent=v; } };

window.addEventListener('load', () => {
  console.log('✅ display.html loaded, starting WebSocket...');

  // Secure-context hint (camera needs HTTPS or localhost)
  const secureOK = location.protocol==='https:' || ['localhost','127.0.0.1'].includes(location.hostname);
  if (!secureOK) console.warn('⚠️ Use HTTPS or localhost for camera access.');

  // Reflect ml5 presence in HUD
  HUD.set('ml5s', window.ml5 ? 'ready' : 'missing');

  // Build WS URL that auto-switches to wss on https
  function wsUrl(port=8080){
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    return `${proto}://${location.hostname}:${port}`;
  }

  socket = new WebSocket(wsUrl(8080));
  socket.onopen  = () => HUD.set('ws','open');
  socket.onclose = () => HUD.set('ws','closed');
  socket.onerror = () => HUD.set('ws','error');
  socket.onmessage = (event) => {
    const text = event.data instanceof Blob ? '' : String(event.data);
    if (event.data instanceof Blob){ const r = new FileReader(); r.onload = ()=>handleIncomingMessage(r.result); r.readAsText(event.data); }
    else { handleIncomingMessage(text); }
  };

  function handleIncomingMessage(message) {
    let data; try { data = JSON.parse(message); } catch { return; }

    // Optional legacy slider mirroring
    if (data.emotion && window.emotionSliders) {
      for (let n in data.emotion) if (window.emotionSliders[n]?.value) window.emotionSliders[n].value(data.emotion[n]);
    }
    if (data.region && window.regionSliders) {
      for (let n in data.region) if (window.regionSliders[n]?.value) window.regionSliders[n].value(data.region[n]);
    }

    // Start/Stop — direct calls (no readiness deferral, rollback style)
    const action = data.type === 'action' ? data.action : data.action;
    if (action === 'start' && typeof window.startTracking === 'function') { window.startTracking(); HUD.set('trk','ON'); }
    if (action === 'stop'  && typeof window.stopTracking  === 'function') { window.stopTracking();  HUD.set('trk','OFF'); }
  }
});
</script>
</body>
</html>