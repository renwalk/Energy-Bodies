<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Energy Bodies — Display</title>
  <link rel="icon" href="data:,">

  <!-- Load p5 and ml5 locally (blocking) -->
  <script src="./p5.min.js"></script>
  <script src="./ml5.min.js"></script>

  <!-- Single sketch include (deferred). Make sure there is ONLY ONE of these. -->
  <script defer src="./sketch.js"></script>

  <style>
    html, body { margin:0; padding:0; background:#000; overflow:hidden; }
    canvas { display:block; }
    #hud { position:fixed; top:10px; left:12px; font:12px system-ui; color:#fff; opacity:.8; background:rgba(24,24,24,.6); padding:6px 8px; border-radius:8px; }
    .pill{ padding:2px 8px; border-radius:999px; background:#222; margin-left:6px; }
  </style>
</head>
<body>
<div id="hud">WS:<span id="ws" class="pill">-</span> ML5:<span id="ml5s" class="pill">-</span> Track:<span id="trk" class="pill">OFF</span></div>

<script>
let socket;
const HUD = { ws:document.getElementById('ws'), ml5s:document.getElementById('ml5s'), trk:document.getElementById('trk'), set(k,v){ this[k].textContent=v; } };

window.addEventListener('load', () => {
  console.log('✅ display.html loaded, starting WebSocket...');

  // Secure-context hint (camera needs HTTPS or localhost)
  const secureOK = location.protocol==='https:' || ['localhost','127.0.0.1'].includes(location.hostname);
  if (!secureOK) console.warn('⚠️ Use HTTPS or localhost for camera access.');

  // Reflect ml5 presence in HUD
  HUD.set('ml5s', window.ml5 ? 'ready' : 'missing');

  // Build WS URL that auto-switches to wss on https
  function wsUrl(port=8080){
    const proto = location.protocol === 'https:' ? 'wss' : 'ws';
    return `${proto}://${location.hostname}:${port}`;
  }

  socket = new WebSocket(wsUrl(8080));
  socket.onopen  = () => HUD.set('ws','open');
  socket.onclose = () => HUD.set('ws','closed');
  socket.onerror = () => HUD.set('ws','error');

  socket.onmessage = (event) => {
    if (event.data instanceof Blob) {
      const r = new FileReader();
      r.onload = () => handleIncomingMessage(r.result);
      r.readAsText(event.data);
    } else {
      handleIncomingMessage(String(event.data));
    }
  };

  function handleIncomingMessage(text) {
    let payload;
    try { payload = JSON.parse(text); } catch { console.warn('[DISPLAY] bad JSON:', text); return; }

    // Optional: mirror sliders sent from control
    if (payload.emotion && window.emotionSliders) {
      for (const n in payload.emotion) {
        window.emotionSliders[n]?.value?.(payload.emotion[n]);
      }
    }
    if (payload.region && window.regionSliders) {
      for (const n in payload.region) {
        window.regionSliders[n]?.value?.(payload.region[n]);
      }
    }

    // Start/Stop actions
    if (payload.type === 'action' || payload.action === 'start') {
      const action = payload.action;
      if (action === 'start' && typeof window.startTracking === 'function') {
        console.log('[DISPLAY] action:start');
        window.startTracking();
        HUD.set('trk','ON');
      }
      if (action === 'stop' && typeof window.stopTracking === 'function') {
        console.log('[DISPLAY] action:stop');
        window.stopTracking();
        HUD.set('trk','OFF');
      }
    }
  }
});
</script>
</body>
</html>